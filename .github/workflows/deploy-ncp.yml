name: Deploy to NCP Server

on:
  push:
    branches: [dev, plz/naver]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  JAR_NAME: CherryPick-0.0.1-SNAPSHOT.jar

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: cherrypick_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      id: setup-java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle/caches
          .gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create test environment file
      run: |
        cat > .env.test << EOF
        NCP_DB_HOST=localhost
        NCP_DB_PORT=5432
        NCP_DB_NAME=cherrypick_test
        NCP_DB_USERNAME=postgres
        NCP_DB_PASSWORD=test_password
        REDIS_HOST=localhost
        REDIS_PORT=6379
        REDIS_PASSWORD=
        JWT_SECRET=test-jwt-secret-key-must-be-at-least-64-characters-long-for-security-purposes
        JWT_EXPIRATION=86400000
        SPRING_PROFILES_ACTIVE=test
        NCP_OBJECT_STORAGE_ENDPOINT=https://kr.object.ncloudstorage.com
        NCP_OBJECT_STORAGE_BUCKET=cherrypick-test
        NCP_ACCESS_KEY_ID=test
        NCP_SECRET_ACCESS_KEY=test
        NCP_REGION=kr-standard
        COMMISSION_RATE=0.03
        NEW_USER_FREE_DAYS=30
        PROMOTION_ENABLED=true
        PROMOTION_RATE=0.00
        PROMOTION_END_DATE=2025-12-31
        EOF

    - name: Wait for services to be ready
      run: |
        echo "â³ Waiting for PostgreSQL to be ready..."
        until pg_isready -h localhost -p 5432 -U postgres; do
          echo "PostgreSQL is unavailable - sleeping"
          sleep 2
        done
        echo "âœ… PostgreSQL is ready!"
        
        echo "â³ Waiting for Redis to be ready..."
        until redis-cli -h localhost -p 6379 ping | grep -q PONG; do
          echo "Redis is unavailable - sleeping"
          sleep 2
        done
        echo "âœ… Redis is ready!"

    - name: Run tests
      env:
        SPRING_PROFILES_ACTIVE: test
      run: |
        echo "ğŸ§ª Running tests with optimized settings..."
        ./gradlew test \
          --parallel \
          --max-workers=4 \
          --build-cache \
          --no-daemon \
          --stacktrace \
          -Dspring.profiles.active=test \
          -Dspring.jpa.hibernate.ddl-auto=create-drop \
          -Dlogging.level.org.hibernate.SQL=ERROR

    - name: Build application
      run: |
        echo "ğŸ”¨ Building application with optimized settings..."
        ./gradlew bootJar \
          --parallel \
          --max-workers=4 \
          --build-cache \
          --no-daemon \
          --stacktrace

    - name: Verify JAR file exists
      run: |
        echo "ğŸ” Checking JAR file..."
        if [ -f "build/libs/${{ env.JAR_NAME }}" ]; then
          echo "âœ… JAR file exists: $(ls -lh build/libs/${{ env.JAR_NAME }})"
          file build/libs/${{ env.JAR_NAME }}
        else
          echo "âŒ JAR file not found!"
          echo "Available files in build/libs/:"
          ls -la build/libs/ || echo "build/libs/ directory doesn't exist"
          exit 1
        fi

    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        mkdir -p deploy
        cp build/libs/${{ env.JAR_NAME }} deploy/
        echo "âœ… Deployment package ready"

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: |
          deploy/
        retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/plz/naver'
    
    steps:
    - name: Checkout code (for scripts)
      uses: actions/checkout@v4

    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: deploy/

    - name: Setup automated SSH connection
      id: setup-ssh
      run: |
        echo "==========================================="
        echo "ğŸš€ ìë™í™”ëœ SSH ì—°ê²° ì„¤ì •"
        echo "==========================================="
        
        # í˜„ì¬ Runner IP í™•ì¸
        RUNNER_IP=$(curl -s ifconfig.me)
        echo "ğŸŒ í˜„ì¬ GitHub Actions Runner IP: $RUNNER_IP"
        echo "runner_ip=$RUNNER_IP" >> $GITHUB_OUTPUT
        
        if [ -z "$RUNNER_IP" ]; then
          echo "âŒ Runner IPë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        echo "ğŸ“‹ NCP ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • ê°€ì´ë“œ:"
        echo "   ë³´ì•ˆ ê·¸ë£¹ ID: ${{ secrets.NCP_SECURITY_GROUP_NO }}"
        echo "   ì¶”ê°€í•  IP ë²”ìœ„ (GitHub Actions):"
        echo "     - 4.148.0.0/16"
        echo "     - 4.149.0.0/18" 
        echo "     - 4.149.64.0/19"
        echo "     - 4.149.96.0/19"
        echo "     - 4.149.128.0/17"
        echo "     - 13.64.0.0/11"
        echo "     - 20.42.0.0/15"
        echo "     - í˜„ì¬ IP: $RUNNER_IP/32"
        echo ""
        echo "ğŸ’¡ ìœ„ IP ë²”ìœ„ë“¤ì„ TCP/22 í¬íŠ¸ë¡œ NCP ë³´ì•ˆ ê·¸ë£¹ì— ë¯¸ë¦¬ ë“±ë¡í•˜ë©´"
        echo "    GitHub Actionsì—ì„œ ìë™ìœ¼ë¡œ SSH ì—°ê²°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."
        
        # SSH ì„¤ì • ìµœì í™”
        echo "ğŸ”§ SSH ì—°ê²° ìµœì í™” ì„¤ì •..."
        sudo apt-get update -qq && sudo apt-get install -y sshpass openssh-client
        
        # SSH ì„¤ì • ìƒì„±
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        cat > ~/.ssh/config << EOF
        Host ncp-server
            HostName ${{ secrets.NCP_SERVER_HOST }}
            Port ${{ secrets.NCP_SERVER_PORT }}
            User ${{ secrets.NCP_SERVER_USER }}
            IdentitiesOnly yes
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
            ConnectTimeout 30
            ServerAliveInterval 60
            ServerAliveCountMax 3
            TCPKeepAlive yes
        EOF
        
        echo "âœ… SSH ì„¤ì • ì™„ë£Œ"

    - name: Setup SSH key
      run: |
        echo "ğŸ” SSH í‚¤ ì„¤ì •..."
        echo "${{ secrets.NCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "âœ… SSH í‚¤ ì„¤ì • ì™„ë£Œ"

    - name: Test SSH connection with multiple methods
      id: test-ssh
      run: |
        echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (ë‹¤ì¤‘ ë°©ë²•)..."
        
        SSH_SUCCESS=false
        
        # ë°©ë²• 1: SSH key only
        echo "ğŸ“¡ ë°©ë²• 1: SSH í‚¤ë§Œ ì‚¬ìš©..."
        if timeout 30 ssh -o BatchMode=yes -o ConnectTimeout=10 ncp-server "echo 'SSH key connection successful'"; then
          echo "âœ… SSH í‚¤ ì—°ê²° ì„±ê³µ!"
          SSH_SUCCESS=true
        else
          echo "âš ï¸ SSH í‚¤ ì—°ê²° ì‹¤íŒ¨"
        fi
        
        # ë°©ë²• 2: SSH key + password (if key failed)
        if [ "$SSH_SUCCESS" = "false" ]; then
          echo "ğŸ“¡ ë°©ë²• 2: SSH í‚¤ + ë¹„ë°€ë²ˆí˜¸..."
          if timeout 30 sshpass -p "${{ secrets.NCP_SSH_PASSWORD }}" ssh -o ConnectTimeout=10 ncp-server "echo 'SSH key+password connection successful'"; then
            echo "âœ… SSH í‚¤+ë¹„ë°€ë²ˆí˜¸ ì—°ê²° ì„±ê³µ!"
            SSH_SUCCESS=true
          else
            echo "âš ï¸ SSH í‚¤+ë¹„ë°€ë²ˆí˜¸ ì—°ê²° ì‹¤íŒ¨"
          fi
        fi
        
        # ë°©ë²• 3: Password only (if both above failed)
        if [ "$SSH_SUCCESS" = "false" ]; then
          echo "ğŸ“¡ ë°©ë²• 3: ë¹„ë°€ë²ˆí˜¸ë§Œ ì‚¬ìš©..."
          if timeout 30 sshpass -p "${{ secrets.NCP_SSH_PASSWORD }}" ssh -o PasswordAuthentication=yes -o PubkeyAuthentication=no -o ConnectTimeout=10 ${{ secrets.NCP_SERVER_USER }}@${{ secrets.NCP_SERVER_HOST }} "echo 'Password-only connection successful'"; then
            echo "âœ… ë¹„ë°€ë²ˆí˜¸ ì—°ê²° ì„±ê³µ!"
            SSH_SUCCESS=true
          else
            echo "âš ï¸ ë¹„ë°€ë²ˆí˜¸ ì—°ê²° ì‹¤íŒ¨"
          fi
        fi
        
        if [ "$SSH_SUCCESS" = "false" ]; then
          echo "âŒ ëª¨ë“  SSH ì—°ê²° ë°©ë²• ì‹¤íŒ¨"
          echo "ğŸ”§ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ:"
          echo "   1. NCP ë³´ì•ˆ ê·¸ë£¹ì— GitHub Actions IP ë²”ìœ„ ì¶”ê°€ í™•ì¸"
          echo "   2. SSH ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸: systemctl status sshd"
          echo "   3. ë°©í™”ë²½ ì„¤ì • í™•ì¸: ufw status"
          echo "   4. SSH í‚¤ ê¶Œí•œ í™•ì¸: chmod 600 ~/.ssh/authorized_keys"
          exit 1
        fi
        
        echo "ssh_success=true" >> $GITHUB_OUTPUT

    - name: Create deployment script
      run: |
        cat > deploy/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        APP_NAME="cherrypick"
        JAR_FILE="CherryPick-0.0.1-SNAPSHOT.jar"
        SERVICE_NAME="cherrypick-app"
        
        echo "ğŸš€ Starting deployment of $APP_NAME..."
        
        # Stop existing service
        sudo systemctl stop $SERVICE_NAME || echo "Service was not running"
        
        # Create comprehensive backup
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        if [ -f "/opt/$APP_NAME/$JAR_FILE" ]; then
            echo "ğŸ“¦ Creating backup: $JAR_FILE.backup.$TIMESTAMP"
            sudo cp "/opt/$APP_NAME/$JAR_FILE" "/opt/$APP_NAME/$JAR_FILE.backup.$TIMESTAMP"
            
            # Verify backup was created successfully
            if [ ! -f "/opt/$APP_NAME/$JAR_FILE.backup.$TIMESTAMP" ]; then
                echo "âŒ Backup creation failed!"
                exit 1
            fi
            
            # Keep only last 5 backups to save space
            sudo find "/opt/$APP_NAME" -name "$JAR_FILE.backup.*" -type f | sort -r | tail -n +6 | sudo xargs rm -f
            echo "âœ… Backup created and old backups cleaned"
        fi
        
        # Backup environment file
        if [ -f "/opt/$APP_NAME/.env.prod" ]; then
            sudo cp "/opt/$APP_NAME/.env.prod" "/opt/$APP_NAME/.env.prod.backup.$TIMESTAMP"
            echo "âœ… Environment file backed up"
        fi
        
        # Deploy new version
        sudo mkdir -p /opt/$APP_NAME
        sudo cp $JAR_FILE /opt/$APP_NAME/
        sudo chown cherrypick:cherrypick /opt/$APP_NAME/$JAR_FILE
        sudo chmod 755 /opt/$APP_NAME/$JAR_FILE
        
        # Start service
        sudo systemctl start $SERVICE_NAME
        sudo systemctl enable $SERVICE_NAME
        
        # Health check with exponential backoff
        echo "â³ Waiting for application to start..."
        for i in {1..20}; do
            if curl -f --connect-timeout 3 --max-time 10 http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy!"
                break
            fi
            # Exponential backoff: 2, 4, 6, 8, 10, then 10s intervals
            wait_time=$((i <= 5 ? i * 2 : 10))
            echo "Waiting ${wait_time}s... ($i/20)"
            sleep $wait_time
        done
        
        if ! curl -f --connect-timeout 5 --max-time 15 http://localhost:8080/actuator/health > /dev/null 2>&1; then
            echo "âŒ Health check failed! Initiating automatic rollback..."
            
            # Stop failed service
            sudo systemctl stop $SERVICE_NAME
            
            # Find and restore latest backup
            LATEST_BACKUP=$(ls -t /opt/$APP_NAME/$JAR_FILE.backup.* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
                echo "ğŸ”„ Rolling back to: $(basename $LATEST_BACKUP)"
                sudo cp "$LATEST_BACKUP" "/opt/$APP_NAME/$JAR_FILE"
                sudo chown cherrypick:cherrypick "/opt/$APP_NAME/$JAR_FILE"
                
                # Restore environment file if exists
                ENV_BACKUP="${LATEST_BACKUP//$JAR_FILE/.env.prod}"
                if [ -f "$ENV_BACKUP" ]; then
                    sudo cp "$ENV_BACKUP" "/opt/$APP_NAME/.env.prod"
                    sudo chown cherrypick:cherrypick "/opt/$APP_NAME/.env.prod"
                    sudo chmod 600 "/opt/$APP_NAME/.env.prod"
                fi
                
                # Start service with old version
                sudo systemctl start $SERVICE_NAME
                sleep 15
                
                # Verify rollback worked
                if curl -f --connect-timeout 5 --max-time 10 http://localhost:8080/actuator/health > /dev/null 2>&1; then
                    echo "âœ… Automatic rollback successful!"
                    echo "âš ï¸  Deployment failed but service restored to previous version"
                    exit 2  # Exit with different code to indicate rollback occurred
                else
                    echo "âŒ Automatic rollback also failed!"
                    exit 1
                fi
            else
                echo "âŒ No backup found for rollback!"
                exit 1
            fi
        fi
        
        echo "ğŸ‰ Deployment completed successfully!"
        EOF
        
        chmod +x deploy/deploy.sh

    - name: Deploy to NCP server
      id: deploy
      run: |
        echo "ğŸš€ Starting deployment to NCP server..."
        
        # íŒŒì¼ ì „ì†¡ ì‹œë„ (ë‹¤ì¤‘ ë°©ë²•)
        TRANSFER_SUCCESS=false
        
        # ë°©ë²• 1: SCP with SSH key
        echo "ğŸ“ ë°©ë²• 1: SCP + SSH í‚¤ë¡œ íŒŒì¼ ì „ì†¡..."
        if timeout 60 scp -o ConnectTimeout=10 -r deploy/ ncp-server:/tmp/; then
          echo "âœ… SCP íŒŒì¼ ì „ì†¡ ì„±ê³µ!"
          TRANSFER_SUCCESS=true
        else
          echo "âš ï¸ SCP íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨"
        fi
        
        # ë°©ë²• 2: SCP with password (if key failed)
        if [ "$TRANSFER_SUCCESS" = "false" ]; then
          echo "ğŸ“ ë°©ë²• 2: SCP + ë¹„ë°€ë²ˆí˜¸ë¡œ íŒŒì¼ ì „ì†¡..."
          if timeout 60 sshpass -p "${{ secrets.NCP_SSH_PASSWORD }}" scp -o ConnectTimeout=10 -r deploy/ ncp-server:/tmp/; then
            echo "âœ… SCP ë¹„ë°€ë²ˆí˜¸ íŒŒì¼ ì „ì†¡ ì„±ê³µ!"
            TRANSFER_SUCCESS=true
          else
            echo "âš ï¸ SCP ë¹„ë°€ë²ˆí˜¸ íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨"
          fi
        fi
        
        if [ "$TRANSFER_SUCCESS" = "false" ]; then
          echo "âŒ íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨"
          exit 1
        fi
        
        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        echo "âš™ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
        if sshpass -p "${{ secrets.NCP_SSH_PASSWORD }}" ssh -o ConnectTimeout=30 ncp-server << 'DEPLOY_EOF'
        set -e
        cd /tmp/deploy
        chmod +x deploy.sh
        ./deploy.sh
        DEPLOY_EOF
        then
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "deployment_status=success" >> $GITHUB_OUTPUT
        else
          DEPLOY_EXIT_CODE=$?
          if [ $DEPLOY_EXIT_CODE -eq 2 ]; then
            echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨í–ˆì§€ë§Œ ìë™ ë¡¤ë°± ì„±ê³µ"
            echo "deployment_status=rolled_back" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

    - name: Cleanup temporary files
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up temporary files..."
        if sshpass -p "${{ secrets.NCP_SSH_PASSWORD }}" ssh -o ConnectTimeout=10 ncp-server "rm -rf /tmp/deploy" 2>/dev/null; then
          echo "âœ… Remote temporary files cleaned"
        else
          echo "âš ï¸ Could not clean remote temporary files (server might be unreachable)"
        fi

    - name: Verify deployment
      id: verify
      if: steps.deploy.outputs.deployment_status == 'success'
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Get server's public health check (if available)
        if curl -f --connect-timeout 10 --max-time 20 "http://${{ secrets.NCP_SERVER_HOST }}:8080/actuator/health" > /dev/null 2>&1; then
          echo "âœ… External health check passed!"
        else
          echo "âš ï¸ External health check not available (this is normal if server is behind firewall)"
        fi
        
        # Verify via SSH
        if sshpass -p "${{ secrets.NCP_SSH_PASSWORD }}" ssh -o ConnectTimeout=10 ncp-server "curl -f http://localhost:8080/actuator/health" > /dev/null 2>&1; then
          echo "âœ… Internal health check passed!"
          echo "verification_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Internal health check failed!"
          echo "verification_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Deployment summary
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ“Š DEPLOYMENT SUMMARY"
        echo "=========================================="
        echo "ğŸŒ Runner IP: ${{ steps.setup-ssh.outputs.runner_ip }}"
        echo "ğŸ”— SSH ì—°ê²°: ${{ steps.test-ssh.outputs.ssh_success == 'true' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}"
        echo "ğŸ“¦ ë°°í¬ ìƒíƒœ: ${{ steps.deploy.outputs.deployment_status }}"
        echo "âœ… ê²€ì¦ ìƒíƒœ: ${{ steps.verify.outputs.verification_status }}"
        echo ""
        
        if [ "${{ steps.deploy.outputs.deployment_status }}" = "success" ]; then
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        elif [ "${{ steps.deploy.outputs.deployment_status }}" = "rolled_back" ]; then
          echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨ í›„ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        else
          echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
        fi
        
        echo "=========================================="
