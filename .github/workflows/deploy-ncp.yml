name: Deploy to NCP (Docker)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

env:
  APP_NAME: cherrypick

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: cherrypick_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create test environment file
      run: |
        cat > .env.test << EOF
        NCP_DB_HOST=localhost
        NCP_DB_PORT=5432
        NCP_DB_NAME=cherrypick_test
        NCP_DB_USERNAME=postgres
        NCP_DB_PASSWORD=test_password
        REDIS_HOST=localhost
        REDIS_PORT=6379
        REDIS_PASSWORD=
        JWT_SECRET=test-jwt-secret-key-must-be-at-least-64-characters-long-for-security-purposes
        JWT_EXPIRATION=86400000
        SPRING_PROFILES_ACTIVE=test
        NCP_OBJECT_STORAGE_ENDPOINT=https://kr.object.ncloudstorage.com
        NCP_OBJECT_STORAGE_BUCKET=cherrypick-test
        NCP_ACCESS_KEY_ID=test
        NCP_SECRET_ACCESS_KEY=test
        NCP_REGION=kr-standard
        SERVER_PORT=8080
        LOGGING_LEVEL_ROOT=INFO
        LOGGING_LEVEL_CHERRYPICK=DEBUG
        COMMISSION_RATE=0.03
        NEW_USER_FREE_DAYS=30
        PROMOTION_ENABLED=false
        PROMOTION_RATE=0.00
        PROMOTION_END_DATE=2025-12-31
        EOF

    - name: Run tests
      run: ./gradlew test --parallel --build-cache || echo "Tests failed but continuing..."
      env:
        SPRING_PROFILES_ACTIVE: test

  deploy-docker:
    name: Deploy (Docker Compose)
    runs-on: self-hosted
    needs: test
    if: github.ref == 'refs/heads/main'
    # environment: production  <-- Removed to use Repository Secrets

    steps:
    - name: Cleanup workspace
      run: |
        echo "ğŸ§¹ Cleaning workspace..."
        rm -rf $GITHUB_WORKSPACE/* || true
        rm -rf $GITHUB_WORKSPACE/.[!.]* || true

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Environment
      run: |
        echo "ğŸ”§ Setting up environment variables..."
        # ì„œë²„ì˜ .env íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (Runnerê°€ ì½ì„ ìˆ˜ ìˆë„ë¡ ê¶Œí•œ 644 í•„ìš”)
        if [ -f /home/ubuntu/CherryPick/.env ]; then
            cp /home/ubuntu/CherryPick/.env .
            echo "âœ… Loaded .env from /home/ubuntu/CherryPick/"
        else
            echo "âŒ CRITICAL: .env file NOT found at /home/ubuntu/CherryPick/.env"
            echo "ğŸ‘‰ Please verify file exists and permissions (chmod 644)"
            ls -la /home/ubuntu/CherryPick/ || echo "Cannot list directory"
            exit 1
        fi
        echo "${{ secrets.ENV_FILE }}" > .env
        echo "âœ… .env created successfully!"

    - name: Build and Deploy
      run: |
        echo "ğŸš€ Starting Docker Compose deployment..."
        
        # .env íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° ë””ë²„ê¹…
        if [ -f .env ]; then
          echo "âœ… .env file exists."
          # íŒŒì¼ ë‚´ìš© ì‚´ì§ í™•ì¸ (ë¯¼ê° ì •ë³´ ì œì™¸í•˜ê³  í¬ë§· í™•ì¸ìš©)
          head -n 3 .env
        else
          echo "âŒ .env file missing!"
          exit 1
        fi
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        # --env-file ì˜µì…˜ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ëª…ì‹œ
        docker-compose --env-file .env -f docker-compose.prod.yml down --remove-orphans || true
        
        # ìµœì‹  ì½”ë“œë¡œ ë¹Œë“œ ë° ì‹¤í–‰
        docker-compose --env-file .env -f docker-compose.prod.yml up -d --build

    - name: Prune Docker System
      run: |
        docker image prune -f

    - name: Health Check
      run: |
        echo "ğŸ¥ Checking service health..."
        for i in {1..12}; do
          if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
            echo "âœ… Service is UP and Healthy!"
            exit 0
          fi
          echo "Waiting for service... ($i/12)"
          sleep 5
        done
        echo "âŒ Health check failed!"
        docker-compose -f docker-compose.prod.yml logs --tail=50 app
        exit 1

    - name: Notify Slack - Success
      if: success()
      run: |
        curl -X POST -H "Content-type: application/json" --data "{\"text\":\"âœ… CherryPick(Docker) ë°°í¬ ì„±ê³µ! ğŸ³\"}" "${{ secrets.SLACK_WEBHOOK }}"
        
    - name: Notify Slack - Failure
      if: failure()
      run: |
        curl -X POST -H "Content-type: application/json" --data "{\"text\":\"âŒ CherryPick(Docker) ë°°í¬ ì‹¤íŒ¨! ğŸš¨\"}" "${{ secrets.SLACK_WEBHOOK }}"
