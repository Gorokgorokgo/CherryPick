name: CherryPick CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# í™˜ê²½ë³€ìˆ˜ ì—†ìŒ (ECR ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: cherrypick_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: "ì½”ë“œ ì²´í¬ì•„ì›ƒ : GitHub ì €ì¥ì†Œì—ì„œ ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ"
        uses: actions/checkout@v4

      - name: "JDK 17 ì„¤ì • : Java 17 ê°œë°œí™˜ê²½ ì„¤ì¹˜ ë° ì„¤ì •"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "corretto"

      - name: "Gradle íŒ¨í‚¤ì§€ ìºì‹œ : ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ìºì‹±ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ"
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ : Gradle Wrapper ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •"
        run: chmod +x gradlew

      - name: "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ : ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
        run: ./gradlew test
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: cherrypick_test
          DB_USERNAME: postgres
          DB_PASSWORD: password123
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-jwt-secret-key-must-be-at-least-64-characters-long-for-testing

      - name: "í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± : í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ GitHub PRì— í‘œì‹œ"
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Gradle í…ŒìŠ¤íŠ¸
          path: build/test-results/test/*.xml
          reporter: java-junit
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: "Secrets í™•ì¸"
        run: |
          echo "EC2_HOST ê¸¸ì´: $(echo '${{ secrets.EC2_HOST }}' | wc -c)"
          echo "EC2_USER ê¸¸ì´: $(echo '${{ secrets.EC2_USER }}' | wc -c)" 
          echo "EC2_SSH_KEY ê¸¸ì´: $(echo '${{ secrets.EC2_SSH_KEY }}' | wc -c)"
          
      - name: "EC2 ë°°í¬ : SSHë¡œ EC2 ì„œë²„ì— ì ‘ì†í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘"
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user/CherryPick
            
            # ìµœì‹  ì½”ë“œ ë°›ê¸°
            git pull origin main
            
            # ê¸°ì¡´ Java í”„ë¡œì„¸ìŠ¤ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
            echo "=== ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ==="
            JAVA_PID=$(ps aux | grep "bootRun" | grep -v grep | awk '{print $2}')
            if [ ! -z "$JAVA_PID" ]; then
                echo "Java í”„ë¡œì„¸ìŠ¤ ì°¾ìŒ: $JAVA_PID"
                kill -TERM $JAVA_PID
                echo "30ì´ˆ ëŒ€ê¸° ì¤‘..."
                sleep 30
                
                # ì—¬ì „íˆ ì‚´ì•„ìˆìœ¼ë©´ ê°•ì œ ì¢…ë£Œ
                if ps -p $JAVA_PID > /dev/null 2>&1; then
                    echo "ê°•ì œ ì¢…ë£Œ ì‹¤í–‰"
                    kill -9 $JAVA_PID
                fi
            else
                echo "ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            fi
            
            # ì´ì „ ë¡œê·¸ ë°±ì—…
            if [ -f app.log ]; then
                mv app.log app.log.bak
            fi
            
            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            source .env
            
            # ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            echo "=== ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ==="
            nohup ./gradlew bootRun > app.log 2>&1 &
            NEW_PID=$!
            echo "ìƒˆ í”„ë¡œì„¸ìŠ¤ PID: $NEW_PID"
            
            # ì‹œì‘ í™•ì¸ (90ì´ˆ ëŒ€ê¸°)
            echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° (90ì´ˆ) ==="
            for i in {1..18}; do
                echo "ëŒ€ê¸° ì¤‘... ${i}/18 ($(($i * 5))ì´ˆ)"
                sleep 5
                
                # í¬íŠ¸ 8080 í™•ì¸
                if netstat -tlnp | grep :8080 > /dev/null; then
                    echo "âœ… í¬íŠ¸ 8080ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!"
                    break
                fi
            done
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo "=== í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ==="
            ps aux | grep java | grep -v grep || echo "Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            echo "=== í¬íŠ¸ ìƒíƒœ ==="
            netstat -tlnp | grep :8080 || echo "8080 í¬íŠ¸ ì‚¬ìš© ì•ˆí•¨"
            
            echo "=== ìµœê·¼ ë¡œê·¸ (50ì¤„) ==="
            tail -50 app.log
            
            echo "=== ì˜¤ë¥˜ ê²€ìƒ‰ ==="
            grep -i "error\|exception\|failed" app.log | tail -15 || echo "íŠ¹ë³„í•œ ì˜¤ë¥˜ ì—†ìŒ"

      - name: "í—¬ìŠ¤ ì²´í¬ : ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë™ì‘ í™•ì¸"
        run: |
          sleep 20
          curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health || echo "í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"

      - name: "ìŠ¬ë™ ì•Œë¦¼ : ë°°í¬ ê²°ê³¼ë¥¼ ìŠ¬ë™ ì±„ë„ë¡œ ì•Œë¦¼"
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#deployments"
          text: |
            ğŸš€ CherryPick ë°°í¬ ${{ job.status }}
            ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref }}
            ğŸ“ ì»¤ë°‹: ${{ github.sha }}
            ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}
